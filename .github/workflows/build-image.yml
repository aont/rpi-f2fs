name: Build Raspberry Pi F2FS image

on:
  workflow_dispatch:
    inputs:
      image_url:
        description: Raspberry Pi OS image URL
        required: false
        default: https://downloads.raspberrypi.com/raspios_arm64/images/raspios_arm64-2025-12-04/2025-12-04-raspios-trixie-arm64.img.xz
      release_tag:
        description: Release tag name (optional). If empty, auto-generate from date/commit/image name.
        required: false
        default: ""

permissions:
  contents: write
  actions: read

jobs:
  build-and-release:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve build metadata
        id: meta
        env:
          INPUT_IMAGE_URL: ${{ github.event.inputs.image_url }}
          INPUT_RELEASE_TAG: ${{ github.event.inputs.release_tag }}
        run: |
          set -euo pipefail

          IMAGE_URL="${INPUT_IMAGE_URL:-https://downloads.raspberrypi.com/raspios_arm64/images/raspios_arm64-2025-12-04/2025-12-04-raspios-trixie-arm64.img.xz}"
          IMAGE_XZ_NAME="$(basename "${IMAGE_URL}")"
          IMAGE_NAME="${IMAGE_XZ_NAME%.img.xz}"
          SRC_IMAGE_NAME="${IMAGE_XZ_NAME%.xz}"
          OUT_IMAGE_NAME="${IMAGE_NAME}-f2fs.img"

          if [[ -n "${INPUT_RELEASE_TAG:-}" ]]; then
            RELEASE_TAG="${INPUT_RELEASE_TAG}"
          else
            RELEASE_TAG="$(date -u +%F)-${GITHUB_SHA::7}-${IMAGE_NAME}"
          fi

          {
            echo "image_url=${IMAGE_URL}"
            echo "image_xz_name=${IMAGE_XZ_NAME}"
            echo "image_name=${IMAGE_NAME}"
            echo "src_image_name=${SRC_IMAGE_NAME}"
            echo "out_image_name=${OUT_IMAGE_NAME}"
            echo "release_tag=${RELEASE_TAG}"
            echo "artifact_name=source-image-${IMAGE_NAME}"
          } >> "$GITHUB_OUTPUT"

      - name: Try reusing cached source artifact from latest successful run
        id: download_cached
        uses: dawidd6/action-download-artifact@v9
        continue-on-error: true
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          workflow: build-image.yml
          workflow_conclusion: success
          name: ${{ steps.meta.outputs.artifact_name }}
          path: .cache
          if_no_artifact_found: warn

      - name: Download source image
        if: steps.download_cached.outcome != 'success' || hashFiles(format('.cache/{0}', steps.meta.outputs.image_xz_name)) == ''
        env:
          IMAGE_URL: ${{ steps.meta.outputs.image_url }}
          IMAGE_XZ_NAME: ${{ steps.meta.outputs.image_xz_name }}
        run: |
          set -euo pipefail
          mkdir -p .cache
          curl -fL --retry 5 --retry-all-errors --retry-delay 2 \
            "${IMAGE_URL}" \
            -o ".cache/${IMAGE_XZ_NAME}"

      - name: Ensure source archive exists
        env:
          IMAGE_XZ_NAME: ${{ steps.meta.outputs.image_xz_name }}
        run: |
          set -euo pipefail
          test -s ".cache/${IMAGE_XZ_NAME}"

      - name: Upload source image artifact for cache reuse
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.meta.outputs.artifact_name }}
          path: .cache/${{ steps.meta.outputs.image_xz_name }}
          if-no-files-found: error
          retention-days: 14

      - name: Unpack source image
        env:
          IMAGE_XZ_NAME: ${{ steps.meta.outputs.image_xz_name }}
        run: |
          set -euo pipefail
          cp ".cache/${IMAGE_XZ_NAME}" .
          xz -T0 -dk "${IMAGE_XZ_NAME}"

      - name: Build F2FS image
        env:
          SRC_IMAGE_NAME: ${{ steps.meta.outputs.src_image_name }}
          OUT_IMAGE_NAME: ${{ steps.meta.outputs.out_image_name }}
        run: |
          set -euo pipefail
          sudo bash ./rpi-f2fs.bash "${SRC_IMAGE_NAME}" "${OUT_IMAGE_NAME}"

      - name: Compress output image
        env:
          OUT_IMAGE_NAME: ${{ steps.meta.outputs.out_image_name }}
        run: |
          set -euo pipefail
          xz -T0 -z -9e "${OUT_IMAGE_NAME}"

      - name: Create release if needed
        env:
          GH_TOKEN: ${{ github.token }}
          RELEASE_TAG: ${{ steps.meta.outputs.release_tag }}
        run: |
          set -euo pipefail
          if gh release view "${RELEASE_TAG}" >/dev/null 2>&1; then
            echo "Release ${RELEASE_TAG} already exists"
          else
            gh release create "${RELEASE_TAG}" --title "${RELEASE_TAG}" --generate-notes
          fi

      - name: Upload image to release
        env:
          GH_TOKEN: ${{ github.token }}
          RELEASE_TAG: ${{ steps.meta.outputs.release_tag }}
          OUT_IMAGE_NAME: ${{ steps.meta.outputs.out_image_name }}
        run: |
          set -euo pipefail
          gh release upload "${RELEASE_TAG}" "${OUT_IMAGE_NAME}.xz" --clobber
